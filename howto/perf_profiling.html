
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Python 对 Linux 性能分析器 perf 的支持 &#8212; Python 3.12.0a0 文档</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/pydoctheme.css?2022.1" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    
    <script src="../_static/sidebar.js"></script>
    
    <link rel="search" type="application/opensearchdescription+xml"
          title="在 Python 3.12.0a0 文档 中搜索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="关于这些文档" href="../about.html" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="copyright" title="版权所有" href="../copyright.html" />
    <link rel="next" title="对象注解属性的最佳实践" href="annotations.html" />
    <link rel="prev" title="使用 DTrace 和 SystemTap 检测CPython" href="instrumentation.html" />
    <link rel="canonical" href="https://docs.python.org/3/howto/perf_profiling.html" />
    
      
    

    
    <style>
      @media only screen {
        table.full-width-table {
            width: 100%;
        }
      }
    </style>
<link rel="shortcut icon" type="image/png" href="../_static/py.svg" />
            <script type="text/javascript" src="../_static/copybutton.js"></script>
            <script type="text/javascript" src="../_static/menu.js"></script> 

  </head>
<body>
<div class="mobile-nav">
    <input type="checkbox" id="menuToggler" class="toggler__input" aria-controls="navigation"
           aria-pressed="false" aria-expanded="false" role="button" aria-label="Menu" />
    <label for="menuToggler" class="toggler__label">
        <span></span>
    </label>
    <nav class="nav-content" role="navigation">
         <a href="https://www.python.org/" class="nav-logo">
             <img src="../_static/py.svg" alt="Logo"/>
         </a>
        <div class="version_switcher_placeholder"></div>
        <form role="search" class="search" action="../search.html" method="get">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="search-icon">
                <path fill-rule="nonzero"
                        d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 001.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 00-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 005.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#444"></path>
            </svg>
            <input type="text" name="q" aria-label="快速搜索"/>
            <input type="submit" value="转向"/>
        </form>
    </nav>
    <div class="menu-wrapper">
        <nav class="menu" role="navigation" aria-label="main navigation">
            <div class="language_switcher_placeholder"></div>
  <div>
    <h3><a href="../contents.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">Python 对 Linux 性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持</a><ul>
<li><a class="reference internal" href="#enabling-perf-profiling-mode">Enabling perf profiling mode</a></li>
<li><a class="reference internal" href="#how-to-obtain-the-best-results">How to obtain the best results</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>上一个主题</h4>
    <p class="topless"><a href="instrumentation.html"
                          title="上一章">使用 DTrace 和 SystemTap 检测CPython</a></p>
  </div>
  <div>
    <h4>下一个主题</h4>
    <p class="topless"><a href="annotations.html"
                          title="下一章">对象注解属性的最佳实践</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>当前页面</h3>
    <ul class="this-page-menu">
      <li><a href="../bugs.html">提交 Bug</a></li>
      <li>
        <a href="https://github.com/python/cpython/blob/main/Doc/howto/perf_profiling.rst"
            rel="nofollow">显示源码
        </a>
      </li>
    </ul>
  </div>
        </nav>
    </div>
</div>

  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python 模块索引"
             >模块</a> |</li>
        <li class="right" >
          <a href="annotations.html" title="对象注解属性的最佳实践"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="instrumentation.html" title="使用 DTrace 和 SystemTap 检测CPython"
             accesskey="P">上一页</a> |</li>

          <li><img src="../_static/py.svg" alt="python logo" style="vertical-align: middle; margin-top: -1px"/></li>
          <li><a href="https://www.python.org/">Python</a> &#187;</li>
          <li class="switchers">
            <div class="language_switcher_placeholder"></div>
            <div class="version_switcher_placeholder"></div>
          </li>
          <li>
              
          </li>
    <li id="cpython-language-and-version">
      <a href="../index.html">3.12.0a0 Documentation</a> &#187;
    </li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Python 常用指引</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Python 对 Linux 性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../search.html" method="get">
          <input placeholder="快速搜索" aria-label="快速搜索" type="text" name="q" />
          <input type="submit" value="转向" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
                     |
                </li>
            
      </ul>
    </div>    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="python-support-for-the-linux-perf-profiler">
<span id="perf-profiling"></span><h1>Python 对 Linux 性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持<a class="headerlink" href="#python-support-for-the-linux-perf-profiler" title="永久链接至标题">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">author</dt>
<dd class="field-odd"><p>Pablo Galindo</p>
</dd>
</dl>
<p>Linux 的 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 分析器是一个非常强大的工具，它允许你分析和获取关于应用程序性能的信息。<code class="docutils literal notranslate"><span class="pre">perf</span></code> 也有一个非常活跃的工具生态系统，可以帮助分析它产生的数据。</p>
<p>在 Python 应用程序中使用 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 分析器的主要问题是，<code class="docutils literal notranslate"><span class="pre">perf</span></code> 只允许获取有关本机符号的信息，即用 C 编写的函数和过程的名称。这意味着代码中的 Python 函数的名称和文件名不会出现在 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的输出中。</p>
<p>从 Python 3.12 开始，解释器可以一种特殊的模式运行，该模式允许 Python 函数出现在性能分析器的输出中。当启用此模式时，解释器将在每个 Python 函数执行之前插入一小段动态编译的代码，并使用 <a class="reference external" href="https://github.com/torvalds/linux/blob/0513e464f9007b70b96740271a948ca5ab6e7dd7/tools/perf/Documentation/jit-interface.txt">perf map files</a> 将这段代码与相关的 Python 函数之间的关系教授给 <code class="docutils literal notranslate"><span class="pre">perf</span></code>。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>对性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持目前只适用于选定架构上的 Linux。检查 configure build 步骤的输出，或者检查 <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">sysconfig</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">HAVE_PERF_TRAMPOLINE</span></code> 的输出，看看是否支持您的系统。</p>
</div>
<p>例如，考虑以下脚本：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">baz</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">bar</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">baz</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
</pre></div>
</div>
<p>可以运行 perf 以 9999 赫兹的频率对 CPU 堆栈跟踪进行采样：</p>
<blockquote>
<div><p>$ perf record -F 9999 -g -o perf.data python my_script.py</p>
</div></blockquote>
<p>然后可以使用 perf 报告来分析数据：</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>perf report --stdio -n -g

<span class="gp"># </span>Children      Self       Samples  Command     Shared Object       Symbol
<span class="gp"># </span>........  ........  ............  ..........  ..................  ..........................................
<span class="gp">#</span>
<span class="go">    91.08%     0.00%             0  python.exe  python.exe          [.] _start</span>
<span class="go">            |</span>
<span class="go">            ---_start</span>
<span class="go">            |</span>
<span class="go">                --90.71%--__libc_start_main</span>
<span class="go">                        Py_BytesMain</span>
<span class="go">                        |</span>
<span class="go">                        |--56.88%--pymain_run_python.constprop.0</span>
<span class="go">                        |          |</span>
<span class="go">                        |          |--56.13%--_PyRun_AnyFileObject</span>
<span class="go">                        |          |          _PyRun_SimpleFileObject</span>
<span class="go">                        |          |          |</span>
<span class="go">                        |          |          |--55.02%--run_mod</span>
<span class="go">                        |          |          |          |</span>
<span class="go">                        |          |          |           --54.65%--PyEval_EvalCode</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     |</span>
<span class="go">                        |          |          |                     |--51.67%--_PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     |          |</span>
<span class="go">                        |          |          |                     |          |--11.52%--_PyLong_Add</span>
<span class="go">                        |          |          |                     |          |          |</span>
<span class="go">                        |          |          |                     |          |          |--2.97%--_PyObject_Malloc</span>
<span class="go">...</span>
</pre></div>
</div>
<p>As you can see here, the Python functions are not shown in the output, only <code class="docutils literal notranslate"><span class="pre">_Py_Eval_EvalFrameDefault</span></code> appears
(the function that evaluates the Python bytecode) shows up. Unfortunately that’s not very useful because all Python
functions use the same C function to evaluate bytecode so we cannot know which Python function corresponds to which
bytecode-evaluating function.</p>
<p>Instead, if we run the same experiment with perf support activated we get:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>perf report --stdio -n -g

<span class="gp"># </span>Children      Self       Samples  Command     Shared Object       Symbol
<span class="gp"># </span>........  ........  ............  ..........  ..................  .....................................................................
<span class="gp">#</span>
<span class="go">    90.58%     0.36%             1  python.exe  python.exe          [.] _start</span>
<span class="go">            |</span>
<span class="go">            ---_start</span>
<span class="go">            |</span>
<span class="go">                --89.86%--__libc_start_main</span>
<span class="go">                        Py_BytesMain</span>
<span class="go">                        |</span>
<span class="go">                        |--55.43%--pymain_run_python.constprop.0</span>
<span class="go">                        |          |</span>
<span class="go">                        |          |--54.71%--_PyRun_AnyFileObject</span>
<span class="go">                        |          |          _PyRun_SimpleFileObject</span>
<span class="go">                        |          |          |</span>
<span class="go">                        |          |          |--53.62%--run_mod</span>
<span class="go">                        |          |          |          |</span>
<span class="go">                        |          |          |           --53.26%--PyEval_EvalCode</span>
<span class="go">                        |          |          |                     py::&lt;module&gt;:/src/script.py</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     py::baz:/src/script.py</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     py::bar:/src/script.py</span>
<span class="go">                        |          |          |                     _PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     PyObject_Vectorcall</span>
<span class="go">                        |          |          |                     _PyEval_Vector</span>
<span class="go">                        |          |          |                     py::foo:/src/script.py</span>
<span class="go">                        |          |          |                     |</span>
<span class="go">                        |          |          |                     |--51.81%--_PyEval_EvalFrameDefault</span>
<span class="go">                        |          |          |                     |          |</span>
<span class="go">                        |          |          |                     |          |--13.77%--_PyLong_Add</span>
<span class="go">                        |          |          |                     |          |          |</span>
<span class="go">                        |          |          |                     |          |          |--3.26%--_PyObject_Malloc</span>
</pre></div>
</div>
<section id="enabling-perf-profiling-mode">
<h2>Enabling perf profiling mode<a class="headerlink" href="#enabling-perf-profiling-mode" title="永久链接至标题">¶</a></h2>
<p>There are two main ways to activate the perf profiling mode. If you want it to be
active since the start of the Python interpreter, you can use the <code class="docutils literal notranslate"><span class="pre">-Xperf</span></code> option:</p>
<blockquote>
<div><p>$ python -Xperf my_script.py</p>
</div></blockquote>
<p>You can also set the <span class="target" id="index-0"></span><a class="reference internal" href="../using/cmdline.html#envvar-PYTHONPERFSUPPORT"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPERFSUPPORT</span></code></a> to a nonzero value to actiavate perf
profiling mode globally.</p>
<p>There is also support for dynamically activating and deactivating the perf
profiling mode by using the APIs in the <a class="reference internal" href="../library/sys.html#module-sys" title="sys: Access system-specific parameters and functions."><code class="xref py py-mod docutils literal notranslate"><span class="pre">sys</span></code></a> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">activate_stack_trampoline</span><span class="p">(</span><span class="s2">&quot;perf&quot;</span><span class="p">)</span>

<span class="c1"># Run some code with Perf profiling active</span>

<span class="n">sys</span><span class="o">.</span><span class="n">deactivate_stack_trampoline</span><span class="p">()</span>

<span class="c1"># Perf profiling is not active anymore</span>
</pre></div>
</div>
<p>These APIs can be handy if you want to activate/deactivate profiling mode in
response to a signal or other communication mechanism with your process.</p>
<p>Now we can analyze the data with <code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">report</span></code>:</p>
<blockquote>
<div><p>$ perf report -g -i perf.data</p>
</div></blockquote>
</section>
<section id="how-to-obtain-the-best-results">
<h2>How to obtain the best results<a class="headerlink" href="#how-to-obtain-the-best-results" title="永久链接至标题">¶</a></h2>
<p>For the best results, Python should be compiled with
<code class="docutils literal notranslate"><span class="pre">CFLAGS=&quot;-fno-omit-frame-pointer</span> <span class="pre">-mno-omit-leaf-frame-pointer&quot;</span></code> as this allows
profilers to unwind using only the frame pointer and not on DWARF debug
information. This is because as the code that is interposed to allow perf
support is dynamically generated it doesn’t have any DWARF debugging information
available.</p>
<p>You can check if you system has been compiled with this flag by running:</p>
<blockquote>
<div><p>$ python -m sysconfig | grep ‘no-omit-frame-pointer’</p>
</div></blockquote>
<p>If you don’t see any output it means that your interpreter has not been compiled with
frame pointers and therefore it may not be able to show Python functions in the output
of <code class="docutils literal notranslate"><span class="pre">perf</span></code>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../contents.html">目录</a></h3>
    <ul>
<li><a class="reference internal" href="#">Python 对 Linux 性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持</a><ul>
<li><a class="reference internal" href="#enabling-perf-profiling-mode">Enabling perf profiling mode</a></li>
<li><a class="reference internal" href="#how-to-obtain-the-best-results">How to obtain the best results</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>上一个主题</h4>
    <p class="topless"><a href="instrumentation.html"
                          title="上一章">使用 DTrace 和 SystemTap 检测CPython</a></p>
  </div>
  <div>
    <h4>下一个主题</h4>
    <p class="topless"><a href="annotations.html"
                          title="下一章">对象注解属性的最佳实践</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>当前页面</h3>
    <ul class="this-page-menu">
      <li><a href="../bugs.html">提交 Bug</a></li>
      <li>
        <a href="https://github.com/python/cpython/blob/main/Doc/howto/perf_profiling.rst"
            rel="nofollow">显示源码
        </a>
      </li>
    </ul>
  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>  
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python 模块索引"
             >模块</a> |</li>
        <li class="right" >
          <a href="annotations.html" title="对象注解属性的最佳实践"
             >下一页</a> |</li>
        <li class="right" >
          <a href="instrumentation.html" title="使用 DTrace 和 SystemTap 检测CPython"
             >上一页</a> |</li>

          <li><img src="../_static/py.svg" alt="python logo" style="vertical-align: middle; margin-top: -1px"/></li>
          <li><a href="https://www.python.org/">Python</a> &#187;</li>
          <li class="switchers">
            <div class="language_switcher_placeholder"></div>
            <div class="version_switcher_placeholder"></div>
          </li>
          <li>
              
          </li>
    <li id="cpython-language-and-version">
      <a href="../index.html">3.12.0a0 Documentation</a> &#187;
    </li>

          <li class="nav-item nav-item-1"><a href="index.html" >Python 常用指引</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Python 对 Linux 性能分析器 <code class="docutils literal notranslate"><span class="pre">perf</span></code> 的支持</a></li>
                <li class="right">
                    

    <div class="inline-search" role="search">
        <form class="inline-search" action="../search.html" method="get">
          <input placeholder="快速搜索" aria-label="快速搜索" type="text" name="q" />
          <input type="submit" value="转向" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
    </div>
                     |
                </li>
            
      </ul>
    </div>  
    <div class="footer">
    &copy; <a href="../copyright.html">版权所有</a> 2001-2022, Python Software Foundation.
    <br />
    This page is licensed under the Python Software Foundation License Version 2.
    <br />
    Examples, recipes, and other code in the documentation are additionally licensed under the Zero Clause BSD License.
    <br />
    See <a href="/license.html">History and License</a> for more information.<br />
    <br />

    The Python Software Foundation is a non-profit corporation.
<a href="https://www.python.org/psf/donations/">Please donate.</a>
<br />
    <br />

    最后更新于 10月 12, 2022.
    <a href="/bugs.html">Found a bug</a>?
    <br />

    由 <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0创建。
    </div>

  </body>
</html>